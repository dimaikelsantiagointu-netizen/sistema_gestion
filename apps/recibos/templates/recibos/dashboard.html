{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}Dashboard | Gestión de Recibos{% endblock %}

{% block content %}
<style>
    /* Estilización de la barra de scroll para los Logs */
    #log-display::-webkit-scrollbar { width: 5px; }
    #log-display::-webkit-scrollbar-track { background: transparent; }
    #log-display::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    #log-display::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
</style>

<div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
    <div>
        <span class="text-[10px] font-black text-intu-red uppercase tracking-[0.3em]">Módulo Operativo</span>
        <h1 class="text-3xl font-black text-intu-blue uppercase tracking-tighter">Gestión de Recibos</h1>
        <p class="text-gray-500 font-medium italic text-sm">Generación, seguimiento y auditoría de pagos institucionales.</p>
    </div>
    
    <div class="flex gap-2">
        <a href="{% url 'recibos:recibos_anulados' %}" class="px-4 py-2 text-[10px] font-black bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition uppercase tracking-wider flex items-center">
            <i class="fas fa-archive mr-2"></i> Ver Recibos Anulados
        </a>
    </div>
</div>

{% if messages %}
<div id="django-message-catcher" style="display:none;">
    {% for message in messages %}
    <div class="message-django" data-type="{{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<div class="flex flex-col lg:flex-row gap-8">

    {# --- PANEL LATERAL (CARGA Y LOGS) --- #}
    <aside class="w-full lg:w-1/3 xl:w-1/4 space-y-6">
        
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
            <h2 class="text-xs font-black text-intu-blue uppercase tracking-widest mb-4 flex items-center">
                <i class="fas fa-file-upload mr-2 text-intu-red"></i> Carga de Archivos Excel
            </h2>
            <form method="post" enctype="multipart/form-data" action="{% url 'recibos:dashboard' %}" id="upload-form" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="upload">
                <label class="block">
                    <input type="file" name="archivo_recibo" id="excel-file-input" accept=".xlsx" required
                        class="block w-full text-[10px] text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-[10px] file:font-black file:uppercase
                        file:bg-gray-100 file:text-gray-600
                        hover:file:bg-intu-blue hover:file:text-white transition-all cursor-pointer">
                </label>
            </form>
            <p id="upload-status" class="mt-4 text-[10px] text-gray-400 italic text-center">Ningún archivo seleccionado.</p>
            
            <button type="button" id="trigger-upload-button" disabled
                class="mt-4 w-full py-3 bg-gray-100 text-gray-400 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all flex justify-center items-center">
                <i class="fas fa-arrow-up mr-2"></i> Esperando Archivo
            </button>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col h-[400px]">
            <h2 class="text-xs font-black text-intu-blue uppercase tracking-widest mb-4 flex items-center shrink-0">
                <i class="fas fa-clipboard-list mr-2 text-intu-red"></i> Procesos y Logs
            </h2>
            
            <div id="log-display" class="flex-grow overflow-y-auto bg-gray-50 p-4 rounded-2xl text-[10px] font-mono text-gray-600 border border-gray-100">
                <div id="log-content-wrapper" class="space-y-2">
                    <p class="text-gray-400 italic">Esperando actividad...</p>
                </div>
            </div>
            
            <button type="button" id="clear-visual-logs-button" 
                data-message="¿Estás seguro que deseas LIMPIAR el contenido visual de los Logs?"
                data-confirm-text="Sí, Limpiar" data-color="gray"
                class="mt-4 w-full py-2 shrink-0 bg-gray-500 text-white text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-gray-600 transition">
                <i class="fas fa-broom mr-2"></i> Limpiar Logs
            </button>
        </div>
    </aside>

    {# --- SECCIÓN PRINCIPAL (FILTROS Y TABLA) --- #}
    <section class="flex-grow space-y-6">

        <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
            <h2 class="text-xs font-black text-intu-blue uppercase tracking-widest mb-6 flex items-center">
                <i class="fas fa-filter mr-2 text-intu-red"></i> Módulo de Reportes y Filtrado
            </h2>

            <form method="get" action="{% url 'recibos:dashboard' %}" id="filter-form" class="space-y-6">
                <input type="hidden" name="search_triggered" value="true">

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Fecha Inicial</label>
                        <input type="date" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}" class="mt-1 block w-full bg-gray-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-intu-blue/10">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Fecha Final</label>
                        <input type="date" name="fecha_fin" value="{{ request.GET.fecha_fin }}" class="mt-1 block w-full bg-gray-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-intu-blue/10">
                    </div>
                    <div class="md:col-span-4">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Estado</label>
                        <select name="estado" class="mt-1 block w-full bg-gray-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-intu-blue/10">
                            <option value="">TODOS LOS ESTADOS</option>
                            {% for estado in estados_db %}
                                <option value="{{ estado }}" {% if request.GET.estado == estado %}selected{% endif %}>
                                    {{ estado|upper }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <fieldset>
                    <legend class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-4">Filtrar por Categorías</legend>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {% for codigo, nombre in categorias_list %}
                        <div class="flex items-center gap-3">
                            <input id="{{ codigo }}" name="{{ codigo }}" type="checkbox" {% if request.GET|get_item:codigo == 'on' %}checked{% endif %}
                                class="w-4 h-4 text-intu-red border-gray-300 rounded focus:ring-intu-red">
                            <label for="{{ codigo }}" class="text-[11px] font-bold text-gray-600 uppercase">{{ nombre }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </fieldset>

                <div class="flex flex-wrap gap-3 pt-6 border-t border-gray-50">
                    <button type="submit" name="action" value="filter" class="flex-[2] py-3 bg-intu-blue text-white text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-intu-dark transition">
                        <i class="fas fa-search mr-2"></i> Aplicar Filtros
                    </button>
                    <a href="{% url 'recibos:dashboard' %}" class="flex-1 py-3 bg-gray-100 text-gray-500 text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-gray-200 transition text-center flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i> Resetear Filtros
                    </a>
                    <button type="submit" name="action" value="excel" formaction="{% url 'recibos:generar_reporte' %}" class="flex-1 py-3 bg-teal-600 text-white text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-teal-700 transition">
                        <i class="fas fa-file-excel mr-2"></i> Reporte Excel
                    </button>
                    <button type="submit" name="action" value="pdf" formaction="{% url 'recibos:generar_reporte' %}" class="flex-1 py-3 bg-red-600 text-white text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-red-700 transition">
                        <i class="fas fa-file-pdf mr-2"></i> Reporte PDF
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-8 border-b border-gray-50">
                <form method="GET" action="." class="flex flex-col md:flex-row gap-4">
                    <input type="hidden" name="search_triggered" value="true">
                    {% for key, value in request.GET.items %}
                        {% if key != 'q' and key != 'page' and key != 'field' and key != 'search_triggered' %}<input type="hidden" name="{{ key }}" value="{{ value }}">{% endif %}
                    {% endfor %}
                    
                    <div class="flex-none">
                        <select name="field" class="bg-gray-50 border-none rounded-xl text-[11px] font-bold uppercase py-2 px-4 focus:ring-2 focus:ring-intu-blue/10">
                            <option value="">TODOS LOS CAMPOS</option>
                            <option value="nombre" {% if request.GET.field == 'nombre' %}selected{% endif %}>NOMBRE</option>
                            <option value="rif_cedula_identidad" {% if request.GET.field == 'rif_cedula_identidad' %}selected{% endif %}>CÉDULA/RIF</option>
                            <option value="numero_recibo" {% if request.GET.field == 'numero_recibo' %}selected{% endif %}>Nº RECIBO</option>
                        </select>
                    </div>
                    <input type="text" name="q" placeholder="Introduce el texto a buscar..." value="{{ request.GET.q|default:'' }}"
                           class="flex-grow bg-gray-50 border-none rounded-xl text-[11px] px-4 focus:ring-2 focus:ring-intu-blue/10">
                    <button type="submit" class="px-6 py-2 bg-intu-blue text-white text-[10px] font-black uppercase rounded-xl hover:bg-intu-dark transition">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50/50">
                        <tr>
                            <th class="px-6 py-4 text-[9px] font-black text-gray-400 uppercase tracking-widest">Nº Recibo</th>
                            <th class="px-6 py-4 text-[9px] font-black text-gray-400 uppercase tracking-widest">Nombre del Contribuyente</th>
                            <th class="px-6 py-4 text-[9px] font-black text-gray-400 uppercase tracking-widest">Cédula/RIF</th>
                            <th class="px-6 py-4 text-[9px] font-black text-gray-400 uppercase tracking-widest text-right">Monto (Bs.)</th>
                            <th class="px-6 py-4 text-[9px] font-black text-gray-400 uppercase tracking-widest text-center">Estado</th>
                            <th class="px-6 py-4 text-[9px] font-black text-gray-400 uppercase tracking-widest text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                    {# Lógica de visualización: Si el usuario activó una búsqueda o filtrado #}
                    {% if request.GET.search_triggered == 'true' or request.GET.q %}
                        
                        {% for recibo in recibos %}
                        <tr class="hover:bg-gray-50/50 transition duration-150 {% if recibo.anulado %}bg-red-50/30 opacity-70{% endif %}">
                            <td class="px-6 py-4">
                                <a href="{% url 'recibos:modificar_recibo' recibo.pk %}" class="text-xs font-black {% if not recibo.anulado %}text-intu-blue hover:text-intu-red{% else %}text-gray-400{% endif %}">
                                    {{ recibo.numero_recibo|stringformat:"04d" }}
                                </a>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-[11px] font-bold text-gray-700 uppercase break-words max-w-[280px] leading-tight">{{ recibo.nombre }}</div>
                                <div class="text-[9px] text-gray-400 mt-1">{{ recibo.fecha|date:"d/m/Y" }}</div>
                            </td>
                            <td class="px-6 py-4 text-[11px] text-gray-500 font-medium">{{ recibo.rif_cedula_identidad }}</td>
                            <td class="px-6 py-4 text-right font-black text-xs text-intu-blue">
                                {{ recibo.total_monto_bs|floatformat:2 }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if recibo.anulado %}
                                    <span class="px-2 py-0.5 bg-red-100 text-red-600 text-[9px] font-black rounded-full uppercase">Anulado</span>
                                {% else %}
                                    <span class="px-2 py-0.5 bg-blue-50 text-blue-600 text-[9px] font-black rounded-full uppercase">{{ recibo.estado|default:"N/A" }}</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex justify-center gap-2">
                                    <a href="{% url 'recibos:generar_pdf_recibo' recibo.pk %}" title="Descargar PDF" class="text-emerald-500 hover:scale-110 transition"><i class="fas fa-file-pdf text-lg"></i></a>
                                    
                                    {% if not recibo.anulado %}
                                        {% if user.is_superuser or user.rol == 'admin' or user.rol == 'superadmin' or recibo.usuario == user %}
                                            <a href="{% url 'recibos:modificar_recibo' pk=recibo.pk %}" title="Modificar" class="text-blue-500 hover:scale-110 transition"><i class="fas fa-edit text-lg"></i></a>
                                        {% else %}
                                            <i class="fas fa-lock text-gray-300 text-lg" title="Solo lectura"></i>
                                        {% endif %}

                                        {% if user.is_superuser or user.rol == 'admin' or user.rol == 'superadmin' %}
                                            <button type="button" class="anular-recibo-btn text-red-500 hover:scale-110 transition"
                                                title="Anular"
                                                data-message="¿Estás seguro que deseas **ANULAR el recibo N°{{ recibo.numero_recibo|stringformat:'04d' }}**?"
                                                data-confirm-text="Sí, Anular" data-color="red" data-action-url="{% url 'recibos:dashboard' %}" data-recibo-id="{{ recibo.pk }}">
                                                <i class="fas fa-times-circle text-lg"></i>
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="p-20 text-center opacity-30">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-search-minus text-5xl mb-4 text-intu-blue"></i>
                                    <p class="text-[10px] font-black uppercase tracking-widest">No se encontraron recibos</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                    {% else %}
                        {# ESTADO INICIAL SIN BÚSQUEDA #}
                        <tr>
                            <td colspan="6" class="p-32 text-center">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <div class="relative">
                                        <div class="absolute inset-0 bg-intu-blue/5 rounded-full animate-ping"></div>
                                        <div class="relative w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center border border-gray-100">
                                            <i class="fas fa-search text-gray-300 text-3xl"></i>
                                        </div>
                                    </div>
                                    <div class="max-w-xs">
                                        <p class="text-[11px] font-black text-intu-blue uppercase tracking-[0.2em]">Búsqueda Requerida</p>
                                        <p class="text-[10px] text-gray-400 font-medium leading-relaxed mt-1">
                                            Utilice los filtros superiores para visualizar los registros.
                                        </p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>

            {% if is_paginated %}
            <div class="p-6 bg-gray-50/50 border-t border-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">
                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ page_obj.paginator.count }}</span>
                <nav class="flex shadow-sm rounded-xl overflow-hidden border border-gray-100">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}{{ request.GET.urlencode|remove_query_param:'page' }}" class="px-4 py-2 bg-white text-gray-500 hover:bg-gray-100 transition"><i class="fas fa-chevron-left text-xs"></i></a>
                    {% endif %}
                    <span class="px-4 py-2 bg-intu-blue text-white text-[10px] font-black">{{ page_obj.number }}</span>
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{{ request.GET.urlencode|remove_query_param:'page' }}" class="px-4 py-2 bg-white text-gray-500 hover:bg-gray-100 transition"><i class="fas fa-chevron-right text-xs"></i></a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>
    </section>
</div>

{# FORMULARIOS OCULTOS #}
<form id="anular-form" method="POST" action="{% url 'recibos:dashboard' %}" class="hidden">
    {% csrf_token %}
    <input type="hidden" name="action" value="anular">
    <input type="hidden" name="recibo_id" id="anular-recibo-id">
</form>

<form id="clear-logs-form" method="POST" action="{% url 'recibos:dashboard' %}" class="hidden">
    {% csrf_token %}
    <input type="hidden" name="action" value="clear_logs">
</form>

{# MODAL DE CONFIRMACIÓN #}
<div id="confirmation-modal" class="fixed inset-0 bg-gray-900/60 z-50 hidden transition-opacity flex items-center justify-center p-4" style="opacity:0;">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 transform transition-all scale-95 opacity-0" id="modal-content">
        <h3 class="text-lg font-black text-intu-blue uppercase tracking-tight mb-4" id="modal-title">Confirmar Acción</h3>
        <p id="modal-message" class="text-sm text-gray-500 leading-relaxed mb-8"></p>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="hideModal()" class="px-6 py-2 text-[10px] font-black uppercase text-gray-400 hover:text-gray-600 transition">Cancelar</button>
            <button type="button" id="confirm-action-button" class="px-6 py-2 bg-red-600 text-white text-[10px] font-black uppercase rounded-xl hover:bg-red-700 transition">Aceptar</button>
        </div>
    </div>
</div>

<script src="{% static 'recibos/js/dashboard.js' %}"></script>
{% endblock %}